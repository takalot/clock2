<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转 拽抓 DAT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>
<body>
    <h2>注 拽抓 DAT</h2>
    <input type="file" id="fileInput" accept=".dat">
    <button onclick="downloadCSV()"> 专转 CSV</button>
    
    <table id="dataTable" class="display">
        <thead>
            <tr>
                <th>砖注</th>
                <th>住 驻注</th>
                <th>转专</th>
                <th>砖注</th>
                <th>ID 注</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                const data = lines.map(line => parseLine(line.trim())).filter(row => row);
                
                populateTable(data);
            };
            reader.readAsText(file);
        }
        
        function parseLine(line) {
            if (line.length < 25) return null;
            return {
                clock: line.substring(0, 3),  // 砖注
                type: line.substring(3, 5) == '06' ? '住' : '爪', // 住 驻注
                date: line.substring(5, 13).replace(/(\d{4})(\d{2})(\d{2})/, '$3/$2/$1'), // 转专
                time: line.substring(13, 17).replace(/(\d{2})(\d{2})/, '$1:$2'), // 砖注
                id: line.substring(17, 25) // ID 注
            };
        }
        
        function populateTable(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            tableBody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.clock}</td><td>${row.type}</td><td>${row.date}</td><td>${row.time}</td><td>${row.id}</td>`;
                tableBody.appendChild(tr);
            });
            
            $('#dataTable').DataTable();
        }
        
        function downloadCSV() {
            let csvContent = "砖注,住 驻注,转专,砖注,ID 注\n";
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                let rowData = Array.from(row.children).map(cell => cell.innerText).join(",");
                csvContent += rowData + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "data.csv";
            link.click();
        }
    </script>
</body>
</html>
