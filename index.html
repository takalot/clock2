import React, { useState, useEffect } from 'react';

// Main App component that handles routing
const App = () => {
  const [page, setPage] = useState('home');
  const [driveFileId, setDriveFileId] = useState(null);
  
  // Function to extract file ID from Google Drive URL
  /*const extractFileId = (url) => {
    const regex = /\/d\/([a-zA-Z0-9_-]+)/;
    const match = url.match(regex);
    return match ? match[1] : null;
  };
  
  // Navigation to file loader page
  const navigateToLoader = (fileUrl) => {
    const fileId = extractFileId(fileUrl);
    setDriveFileId(fileId);
    setPage('loader');
  };
  */
  // Return to home page
  const navigateToHome = () => {
    setPage('home');
  };
  
  return (
    <div className="min-h-screen bg-gray-50">
      {page === 'home' && (
        <HomePage onNavigateToLoader={navigateToLoader} />
      )}
      
      {page === 'loader' && (
        <LoaderPage 
          fileId={driveFileId} 
          onBackToHome={navigateToHome} 
        />
      )}
    </div>
  );
};

// Home Page Component
const HomePage = ({ onNavigateToLoader }) => {
  const [googleDriveLink, setGoogleDriveLink] = useState('');
  
  return (
    <div className="p-4" dir="rtl">
      <div className="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 className="text-2xl font-bold mb-6 text-center">מערכת לעיבוד נתוני נוכחות</h1>
        
        <div className="mb-8">
          <h2 className="text-xl font-semibold mb-4">טעינת קובץ מגוגל דרייב</h2>
          <p className="mb-4">קישור זה יפתח דף חדש שימשוך את קובץ הנוכחות ישירות מגוגל דרייב.</p>
          
          <div className="mb-4">
            <label className="block mb-2 font-medium">קישור לקובץ בגוגל דרייב:</label>
            <input 
              type="text" 
              value={googleDriveLink}
              onChange={(e) => setGoogleDriveLink(e.target.value)}
              placeholder="הכנס קישור לקובץ טקסט בגוגל דרייב" 
              className="w-full p-2 border border-gray-300 rounded-lg mb-2"
            />
            <p className="text-xs text-gray-500">דוגמה: https://drive.google.com/file/d/19mKb2jSMI59M3pjeIEr6NlSaB8yhAAAk/view?usp=sharing</p>
          </div>
          
          <button 
            onClick={() => onNavigateToLoader(googleDriveLink)}
            className="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium w-full md:w-auto"
          >
            פתח דף טעינה אוטומטית
          </button>
        </div>
        
        <div className="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h3 className="font-medium mb-2">הסבר על המערכת:</h3>
          <p className="text-sm mb-2">מערכת זו מעבדת נתוני נוכחות מקבצים בפורמט מוגדר:</p>
          <ul className="text-sm list-disc list-inside space-y-1 mb-2">
            <li>123 = מזהה שעון</li>
            <li>45 = לא בשימוש</li>
            <li>6 = סוג פעולה (1=כניסה, 2=יציאה)</li>
            <li>789101112 = תאריך (DDMMYY)</li>
            <li>13141516 = שעה (HHMM)</li>
            <li>171819202122232425 = מזהה ID עובד</li>
          </ul>
          <p className="text-sm">דוגמה לשורה: 07700217072415220319123468</p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 className="font-medium mb-2 text-blue-700">טבלת שעונים</h3>
            <p className="text-sm">קובץ JSON בפורמט:</p>
            <pre className="text-xs bg-white p-2 rounded mt-1 overflow-x-auto">
              [{"id":"123","name":"שם השעון"}]
            </pre>
          </div>
          
          <div className="p-4 bg-green-50 rounded-lg border border-green-200">
            <h3 className="font-medium mb-2 text-green-700">טבלת אנשים</h3>
            <p className="text-sm">קובץ JSON בפורמט:</p>
            <pre className="text-xs bg-white p-2 rounded mt-1 overflow-x-auto">
              [{"id":"123456789","name":"שם מלא"}]
            </pre>
          </div>
        </div>
      </div>
    </div>
  );
};

// Loader Page Component
const LoaderPage = ({ fileId, onBackToHome }) => {
  const [fileData, setFileData] = useState('');
  const [parsedData, setParsedData] = useState([]);
  const [clocks, setClocks] = useState([]);
  const [people, setPeople] = useState([]);
  const [sortBy, setSortBy] = useState('date');
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Process the raw text data into structured format
  const processData = (text) => {
    const lines = text.split('\n').filter(line => line.trim().length > 0);
    const processed = [];

    lines.forEach(line => {
      if (line.length < 25) return; // Skip if line is too short
      
      try {
        const clockId = line.substring(0, 3);
        const actionType = line.substring(5, 6) === '1' ? 'כניסה' : 'יציאה';
        
        // Parse date: DDMMYYYY
        const day = line.substring(6, 8);
        const month = line.substring(8, 10);
        const year = line.substring(10, 12);
        const date = `${day}/${month}/20${year}`;
        
        // Parse time: HHMM
        const hour = line.substring(12, 14);
        const minute = line.substring(14, 16);
        const time = `${hour}:${minute}`;
        
        // Parse ID
        const personId = line.substring(16, 25);
        
        processed.push({
          clockId,
          actionType,
          date,
          time,
          personId,
          rawData: line
        });
      } catch (e) {
        console.error("Failed to parse line:", line, e);
      }
    });
    
    return processed;
  };

  // Load sample clock data
  const loadSampleClockData = () => {
    const sampleClocks = [
      { "id": "077", "name": "שעון ראשי" },
      { "id": "001", "name": "שעון כניסה A" },
      { "id": "002", "name": "שעון כניסה B" }
    ];
    setClocks(sampleClocks);
  };

  // Load sample people data
  const loadSamplePeopleData = () => {
    const samplePeople = [
      { "id": "123456789", "name": "ישראל ישראלי" },
      { "id": "987654321", "name": "יעקב יעקובי" },
      { "id": "376891234", "name": "שרה כהן" }
    ];
    setPeople(samplePeople);
  };

  // Load data from Google Drive (simulated)
  useEffect(() => {
    if (!fileId) {
      setError("מזהה קובץ לא תקין");
      setIsLoading(false);
      return;
    }
    
    // Load sample data for tables
    loadSampleClockData();
    loadSamplePeopleData();
    
    // Simulate loading file from Google Drive
    setTimeout(() => {
      // Simulated data from Google Drive
      const mockData = `077002170724152203191234681
077002170724152203191234682
077002180724152903297654321
077002180724153003297654322
077001190724141203768912341
077001190724180003768912342`;
      
      setFileData(mockData);
      setParsedData(processData(mockData));
      setIsLoading(false);
    }, 2000);
  }, [fileId]);

  // Get clock name by ID
  const getClockName = (id) => {
    const clock = clocks.find(c => c.id === id);
    return clock ? clock.name : id;
  };

  // Get person name by ID
  const getPersonName = (id) => {
    const person = people.find(p => p.id === id);
    return person ? person.name : id;
  };

  // Sort data based on selected criteria
  const sortedData = [...parsedData].sort((a, b) => {
    if (sortBy === 'clock') {
      return a.clockId.localeCompare(b.clockId);
    } else if (sortBy === 'person') {
      return a.personId.localeCompare(b.personId);
    } else if (sortBy === 'date') {
      // Sort by date then time
      const dateA = new Date(`20${a.date.slice(6)}-${a.date.slice(3, 5)}-${a.date.slice(0, 2)} ${a.time}`);
      const dateB = new Date(`20${b.date.slice(6)}-${b.date.slice(3, 5)}-${b.date.slice(0, 2)} ${b.time}`);
      return dateA - dateB;
    }
    return 0;
  });
  
  return (
    <div className="p-4" dir="rtl">
      <div className="max-w-6xl mx-auto">
        <div className="flex items-center mb-6">
          <button 
            onClick={onBackToHome}
            className="mr-4 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded"
          >
            חזרה
          </button>
          <h1 className="text-2xl font-bold">עיבוד נתוני נוכחות</h1>
        </div>
        
        {isLoading ? (
          <div className="bg-white p-12 rounded-lg shadow-md text-center">
            <div className="mb-4 text-blue-600 font-medium">טוען נתונים מגוגל דרייב...</div>
            <div className="w-16 h-16 border-4 border-t-blue-600 border-blue-200 rounded-full animate-spin mx-auto"></div>
            <div className="mt-4 text-gray-500 text-sm">מזהה קובץ: {fileId}</div>
          </div>
        ) : error ? (
          <div className="bg-white p-8 rounded-lg shadow-md">
            <div className="text-red-600 mb-4">{error}</div>
            <button 
              onClick={onBackToHome}
              className="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded"
            >
              חזרה לדף הראשי
            </button>
          </div>
        ) : (
          <div>
            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-semibold">פרטי הקובץ</h2>
                <div className="bg-green-100 text-green-800 text-sm py-1 px-3 rounded">
                  נטען בהצלחה
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div className="p-3 bg-gray-50 rounded">
                  <div className="font-medium">מזהה קובץ:</div>
                  <div className="text-sm overflow-hidden overflow-ellipsis">{fileId}</div>
                </div>
                <div className="p-3 bg-gray-50 rounded">
                  <div className="font-medium">מספר רשומות:</div>
                  <div>{parsedData.length}</div>
                </div>
                <div className="p-3 bg-gray-50 rounded">
                  <div className="font-medium">טבלאות נתונים:</div>
                  <div className="text-sm">שעונים: {clocks.length}, אנשים: {people.length}</div>
                </div>
              </div>
            </div>
            
            <div className="bg-white p-6 rounded-lg shadow-md">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-semibold">תוצאות ({parsedData.length} רשומות)</h2>
                
                <div className="flex items-center">
                  <label className="mr-2">מיון לפי:</label>
                  <select 
                    value={sortBy} 
                    onChange={(e) => setSortBy(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg"
                  >
                    <option value="date">תאריך ושעה</option>
                    <option value="clock">שעון</option>
                    <option value="person">איש</option>
                  </select>
                </div>
              </div>
              
              <div className="overflow-x-auto">
                <table className="min-w-full bg-white border border-gray-200">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="py-2 px-4 border-b border-r">שעון</th>
                      <th className="py-2 px-4 border-b border-r">סוג פעולה</th>
                      <th className="py-2 px-4 border-b border-r">תאריך</th>
                      <th className="py-2 px-4 border-b border-r">שעה</th>
                      <th className="py-2 px-4 border-b border-r">מזהה עובד</th>
                      <th className="py-2 px-4 border-b">שם עובד</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedData.map((item, index) => (
                      <tr key={index} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                        <td className="py-2 px-4 border-b border-r">{getClockName(item.clockId)}</td>
                        <td className="py-2 px-4 border-b border-r">{item.actionType}</td>
                        <td className="py-2 px-4 border-b border-r">{item.date}</td>
                        <td className="py-2 px-4 border-b border-r">{item.time}</td>
                        <td className="py-2 px-4 border-b border-r">{item.personId}</td>
                        <td className="py-2 px-4 border-b">{getPersonName(item.personId)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              
              <div className="mt-4 flex gap-2">
                <button 
                  onClick={() => {
                    const csv = [
                      'שעון,סוג פעולה,תאריך,שעה,מזהה עובד,שם עובד',
                      ...sortedData.map(item => 
                        `${getClockName(item.clockId)},${item.actionType},${item.date},${item.time},${item.personId},${getPersonName(item.personId)}`
                      )
                    ].join('\n');
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'attendance_data.csv';
                    link.click();
                  }}
                  className="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg"
                >
                  ייצוא ל-CSV
                </button>
                
                <button 
                  onClick={onBackToHome}
                  className="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg"
                >
                  חזרה לדף הראשי
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
